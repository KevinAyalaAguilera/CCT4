<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control de facturas por Ruta</title>

  <style>
    :root {
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }

    body {
      margin: 0;
      background: #f5f7fb;
      color: #111;
    }

    header {
      background: #c53030;
      color: #fff;
      padding: 18px 24px;
      border-bottom: 4px solid rgba(0, 0, 0, 0.06)
    }

    .container {
      display: flex;
      gap: 18px;
      padding: 18px;
      max-width: 1400px;
      margin: 20px auto
    }

    .panel {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(16, 24, 40, 0.06);
      flex: 1
    }

    .left {
      min-width: 350px;
      max-width: 420px
    }

    h1 {
      margin: 0 0 6px;
      font-size: 18px
    }

    label {
      display: block;
      margin-top: 8px;
      font-size: 13px
    }

    input[type=file] {
      margin-top: 6px
    }

    .dropzone {
      margin-top: 10px;
      padding: 18px;
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      text-align: center;
      color: #64748b;
      cursor: pointer
    }

    .dropzone.dragover {
      background: #ffecec;
      border-color: #c53030;
      color: #2b2b2b
    }

    #routesContainer {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .route-card {
      border: 1px solid #f2d6d6;
      padding: 14px;
      border-radius: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 13px;
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    .status {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px
    }

    .status.missing {
      background: #fff4e6;
      color: #b45309;
      border: 1px solid #fde3b7
    }

    .status.ok {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #bbf7d0
    }

    .btn {
      padding: 8px 12px;
      border-radius: 8px;
      background: #c53030;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 13px;
      margin-right: 4px;
    }

    .btn.small {
      font-size: 12px;
      padding: 6px 8px;
    }

    .note {
      font-size: 13px;
      color: #374151
    }
  </style>
</head>

<body>

<header>
  <h1>Control de Facturas por Ruta — Subir, Comprobar y Agrupar</h1>
</header>

<div class="container">
  <div class="panel left">
    <label>1) Cargar archivo Excel (.xlsx)</label>
    <input id="xlsxInput" type="file" accept=".xlsx" />
    <div class="note">Columnas: <b>Transportista, Ruta, Identificador de tarea, Representante del cliente</b></div>

    <label style="margin-top:12px">2) Arrastra o selecciona PDFs</label>
    <div id="dropzone" class="dropzone">Arrastra PDF aquí o haz click</div>
    <input id="pdfFileInput" type="file" accept="application/pdf" multiple style="display:none" />

    <label style="margin-top:12px">Acciones</label>
    <button id="clearAll" class="btn small" style="background:#eee;color:#c53030;border:1px solid #f4c7c7">Limpiar Todo</button>
    <button id="exportAllMissing" class="btn small">Exportar Pendientes (XLSX)</button>
  </div>

  <div class="panel" id="mainPanel">
    <div id="routesContainer"></div>
  </div>
</div>

<script src="xlsx.full.min.js"></script>
<script src="pdf-lib.min.js"></script>
<script src="pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.min.js';

let rows = [];
const routeMap = new Map();

document.getElementById('xlsxInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const buffer = await file.arrayBuffer();
  const workbook = XLSX.read(buffer, { type: 'array' });
  const sheet = workbook.SheetNames[0];
  const data = XLSX.utils.sheet_to_json(workbook.Sheets[sheet], { defval: '' });

  rows = [];
  routeMap.clear();

  data.forEach(r => {
    const obj = {
      Transportista: r["Transportista"],
      Ruta: r["Ruta"],
      Identificador: String(r["Identificador de tarea"]).trim(),
      Representante: r["Representante del cliente"],
      uploaded: false,
      pdfs: []
    };
    rows.push(obj);
    if (!routeMap.has(obj.Ruta)) routeMap.set(obj.Ruta, []);
    routeMap.get(obj.Ruta).push(rows.length - 1);
  });

  renderRouteTables();
});

function renderRouteTables() {
  routesContainer.innerHTML = '';
  for (const [ruta, idxs] of routeMap.entries()) {
    const t = rows[idxs[0]].Transportista;
    const card = document.createElement('div');
    card.className = 'route-card';
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${t} — Ruta: ${ruta}</strong>
        <button class="btn small dl-all" data-ruta="${encodeURIComponent(ruta)}">Descargar Ruta PDF</button>
      </div>
      <table>
        <thead><tr><th>Identificador</th><th>Representante</th><th>Factura</th></tr></thead>
        <tbody></tbody>
      </table>
    `;
    routesContainer.appendChild(card);

    const tbody = card.querySelector("tbody");
    idxs.forEach(i => {
      const r = rows[i];
      const tr = document.createElement("tr");
      tr.dataset.idx = i;
      tr.innerHTML = `
        <td>${r.Identificador}</td>
        <td>${r.Representante}</td>
        <td><span class="status ${r.uploaded ? "ok" : "missing"}">${r.uploaded ? "✅ Subida" : "⏳ Pendiente"}</span></td>
      `;
      tbody.appendChild(tr);
    });

    card.querySelector('.dl-all')
      .addEventListener('click', () => downloadGroupedRuta(ruta));
  }
}

// Drag & drop PDF
const dropzone = document.getElementById('dropzone');
const pdfFileInput = document.getElementById('pdfFileInput');

dropzone.addEventListener('click', () => pdfFileInput.click());
dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
pdfFileInput.addEventListener('change', e => handleFiles(e.target.files));

async function handleFiles(files) {
  files = [...files].filter(f => f.type === 'application/pdf');
  for (const f of files) await processPdf(f);
  updateTablesUI();
}

async function processPdf(file) {
  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

  let text = "";
  for (let p = 1; p <= pdf.numPages; p++) {
    const page = await pdf.getPage(p);
    const c = await page.getTextContent();
    text += c.items.map(i => i.str).join(" ") + "\n";
  }

  const matches = rows.map((r, i) => text.includes(r.Identificador) ? i : -1).filter(i => i !== -1);
  if (!matches.length) return;

  const cleaned = await removeLastTwoPages(buffer);

  matches.forEach(i => {
    rows[i].uploaded = true;
    rows[i].pdfs.push({ name: file.name, bytes: cleaned });
  });
}

async function removeLastTwoPages(buffer) {
  const { PDFDocument } = PDFLib;
  const src = await PDFDocument.load(buffer);
  const count = src.getPageCount();
  const out = await PDFDocument.create();
  const pages = await out.copyPages(src, Array.from({ length: Math.max(count - 2, 1) }, (_, i) => i));
  pages.forEach(p => out.addPage(p));
  return await out.save();
}

function updateTablesUI() {
  document.querySelectorAll('tbody tr').forEach(tr => {
    const i = tr.dataset.idx;
    const cell = tr.querySelector('.status');
    cell.className = 'status ' + (rows[i].uploaded ? 'ok' : 'missing');
    cell.textContent = rows[i].uploaded ? '✅ Subida' : '⏳ Pendiente';
  });
}

async function downloadGroupedRuta(ruta) {
  const { PDFDocument, StandardFonts } = PDFLib;
  const idxs = routeMap.get(ruta) || [];
  const docs = [];
  idxs.forEach(i => rows[i].pdfs.forEach(p => docs.push(p.bytes)));

  if (!docs.length) return alert("Esta ruta no tiene facturas cargadas.");

  const out = await PDFDocument.create();
  const font = await out.embedFont(StandardFonts.HelveticaBold);

  for (const bytes of docs) {
    const src = await PDFDocument.load(bytes);
    const pages = await out.copyPages(src, src.getPageIndices());
    pages.forEach(p => out.addPage(p));
  }

  out.getPages().forEach(p => {
    p.drawText(ruta, { x: 20, y: p.getHeight() - 40, size: 32, font, opacity: 0.85 });
  });

  const pdf = await out.save();
  const url = URL.createObjectURL(new Blob([pdf], { type: "application/pdf" }));
  const a = document.createElement('a');
  a.href = url;
  a.download = `RUTA_${ruta}.pdf`;
  a.click();
  URL.revokeObjectURL(url);
}

document.getElementById('exportAllMissing').addEventListener('click', () => {
  const pending = rows.filter(r => !r.uploaded);
  if (!pending.length) return alert("No hay pendientes.");
  const sheet = XLSX.utils.json_to_sheet(pending);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, sheet, "Pendientes");
  XLSX.writeFile(wb, "pendientes_facturas.xlsx");
});

document.getElementById('clearAll').addEventListener('click', () => {
  if (confirm("¿Seguro? Esto vacía todo.")) location.reload();
});
</script>
</body>
</html>
